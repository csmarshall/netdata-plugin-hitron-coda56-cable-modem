# Comprehensive Netdata health configuration for Hitron CODA cable modem
# Install to: /etc/netdata/health.d/hitron_coda.conf

# -----------------------------------------------------------------------------
# Downstream QAM Power Level Monitoring (31 channels!)
# Optimal range: -15 to +15 dBmV
# Warning: < -15 or > +15 dBmV
# Critical: < -20 or > +20 dBmV

template: hitron_coda_downstream_power_low
      on: hitron_coda.downstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: $this / 10  # Scale back from stored value
   units: dBmV
   every: 10s
    warn: $this < -15
    crit: $this < -20
   delay: down 5m multiplier 1.5 max 1h
    info: downstream QAM channel power level is too low
      to: webmaster

template: hitron_coda_downstream_power_high
      on: hitron_coda.downstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: $this / 10  # Scale back from stored value
   units: dBmV
   every: 10s
    warn: $this > 15
    crit: $this > 20
   delay: down 5m multiplier 1.5 max 1h
    info: downstream QAM channel power level is too high
      to: webmaster

# -----------------------------------------------------------------------------
# Downstream QAM SNR Monitoring
# Good: > 30 dB
# Warning: < 30 dB
# Critical: < 25 dB

template: hitron_coda_downstream_snr_low
      on: hitron_coda.downstream_snr
   class: Latency
    type: Cable Modem
component: Network
    calc: $this / 100  # Scale back from stored value
   units: dB
   every: 10s
    warn: $this < 30
    crit: $this < 25
   delay: down 3m multiplier 1.5 max 1h
    info: downstream QAM channel SNR is degraded, may cause connection issues
      to: webmaster

# -----------------------------------------------------------------------------
# Downstream QAM Error Monitoring
# Monitor corrected error rate (errors per second)

template: hitron_coda_downstream_corrected_rate
      on: hitron_coda.downstream_corrected
   class: Errors
    type: Cable Modem
component: Network
    calc: $this
   units: errors/s
   every: 10s
    warn: $this > 100
    crit: $this > 1000
   delay: down 2m multiplier 1.2 max 30m
    info: high rate of corrected errors on downstream QAM channels
      to: webmaster

template: hitron_coda_downstream_uncorrected_rate
      on: hitron_coda.downstream_uncorrected
   class: Errors
    type: Cable Modem
component: Network
    calc: $this
   units: errors/s
   every: 10s
    warn: $this > 10
    crit: $this > 100
   delay: down 1m multiplier 1.2 max 20m
    info: uncorrected errors detected on downstream QAM channels, packet loss likely
      to: webmaster

# -----------------------------------------------------------------------------
# Channel 31 Special Monitoring
# Your data shows Channel 31 has significantly higher errors (44902 corrected, 14844 uncorrected)

 alarm: hitron_coda_channel_31_degraded
    on: hitron_coda.downstream_uncorrected
   class: Errors
    type: Cable Modem
component: Network
    calc: $ds_uncorrected_31
   units: errors/s
   every: 30s
    warn: $this > 50
    crit: $this > 200
   delay: down 2m multiplier 1.5 max 30m
    info: Channel 31 showing high uncorrected errors - this channel has known issues
      to: webmaster

# -----------------------------------------------------------------------------
# Upstream QAM Power Level Monitoring (5 channels)
# Optimal range: 35 to 50 dBmV (higher than downstream)
# Warning: < 35 or > 50 dBmV
# Critical: < 30 or > 55 dBmV

template: hitron_coda_upstream_power_low
      on: hitron_coda.upstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: $this / 100  # Scale back from stored value
   units: dBmV
   every: 10s
    warn: $this < 35
    crit: $this < 30
   delay: down 5m multiplier 1.5 max 1h
    info: upstream QAM channel power level is too low, may cause upload issues
      to: webmaster

template: hitron_coda_upstream_power_high
      on: hitron_coda.upstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: $this / 100  # Scale back from stored value
   units: dBmV
   every: 10s
    warn: $this > 50
    crit: $this > 55
   delay: down 5m multiplier 1.5 max 1h
    info: upstream QAM channel power level is too high, modem may be overdriving
      to: webmaster

# -----------------------------------------------------------------------------
# OFDM Downstream Power Monitoring (DOCSIS 3.1)
# OFDM power levels are typically lower than QAM
# Warning: < -10 or > +10 dBmV
# Critical: < -15 or > +15 dBmV

template: hitron_coda_ofdm_downstream_power_low
      on: hitron_coda.ofdm_downstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: $this / 100  # Scale back from stored value
   units: dBmV
   every: 10s
    warn: $this < -10
    crit: $this < -15
   delay: down 5m multiplier 1.5 max 1h
    info: OFDM downstream channel power level is too low
      to: webmaster

template: hitron_coda_ofdm_downstream_power_high
      on: hitron_coda.ofdm_downstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: $this / 100  # Scale back from stored value
   units: dBmV
   every: 10s
    warn: $this > 10
    crit: $this > 15
   delay: down 5m multiplier 1.5 max 1h
    info: OFDM downstream channel power level is too high
      to: webmaster

# -----------------------------------------------------------------------------
# OFDM Downstream SNR Monitoring
# OFDM typically has better SNR than QAM
# Warning: < 35 dB
# Critical: < 30 dB

template: hitron_coda_ofdm_downstream_snr_low
      on: hitron_coda.ofdm_downstream_snr
   class: Latency
    type: Cable Modem
component: Network
    calc: $this
   units: dB
   every: 10s
    warn: $this < 35
    crit: $this < 30
   delay: down 3m multiplier 1.5 max 1h
    info: OFDM downstream channel SNR is degraded
      to: webmaster

# -----------------------------------------------------------------------------
# Downstream Throughput Monitoring
# Monitor for significant drops in data throughput

template: hitron_coda_downstream_throughput_drop
      on: hitron_coda.downstream_throughput
   class: Utilization
    type: Cable Modem
component: Network
    calc: $this
   units: octets/s
   every: 60s
    warn: $this < $this@10m * 0.5
    crit: $this < $this@10m * 0.2
   delay: down 5m multiplier 1.5 max 30m
    info: downstream throughput has dropped significantly compared to 10 minutes ago
      to: webmaster

# -----------------------------------------------------------------------------
# OFDM Throughput Monitoring
# OFDM channels handle much higher throughput

template: hitron_coda_ofdm_throughput_drop
      on: hitron_coda.ofdm_downstream_throughput
   class: Utilization
    type: Cable Modem
component: Network
    calc: $this
   units: octets/s
   every: 60s
    warn: $this < $this@10m * 0.3
    crit: $this < $this@10m * 0.1
   delay: down 5m multiplier 1.5 max 30m
    info: OFDM downstream throughput has dropped significantly
      to: webmaster

# -----------------------------------------------------------------------------
# Frequency Stability Monitoring
# Monitor for frequency drift on downstream channels

template: hitron_coda_downstream_frequency_drift
      on: hitron_coda.downstream_frequency
   class: Latency
    type: Cable Modem
component: Network
    calc: $this
   units: MHz
   every: 300s
    warn: abs($this - $this@1h) > 6
    crit: abs($this - $this@1h) > 12
   delay: down 15m multiplier 1.5 max 2h
    info: downstream frequency has drifted from expected value
      to: webmaster

# -----------------------------------------------------------------------------
# Upstream Frequency Monitoring
# Your upstream frequencies: 16.4, 22.8, 29.2, 35.6, 40.4 MHz

template: hitron_coda_upstream_frequency_drift
      on: hitron_coda.upstream_frequency
   class: Latency
    type: Cable Modem
component: Network
    calc: $this
   units: MHz
   every: 300s
    warn: $this < 5 OR $this > 85
    crit: $this < 1 OR $this > 100
   delay: down 10m multiplier 1.5 max 2h
    info: upstream frequency is outside normal DOCSIS range
      to: webmaster

# -----------------------------------------------------------------------------
# Upstream Bandwidth Monitoring
# Your channels use 3.2 and 6.4 MHz bandwidths

template: hitron_coda_upstream_bandwidth_change
      on: hitron_coda.upstream_bandwidth
   class: Workload
    type: Cable Modem
component: Network
    calc: $this / 10  # Scale back from stored value
   units: MHz
   every: 300s
    warn: $this != $this@1h
   delay: down 30m multiplier 1.5 max 4h
    info: upstream channel bandwidth has changed, possible ISP configuration update
      to: webmaster

# -----------------------------------------------------------------------------
# System Uptime Monitoring
# Warning: Modem rebooted recently (uptime < 1 hour)

 alarm: hitron_coda_modem_rebooted
    on: hitron_coda.system_uptime
   class: Latency
    type: Cable Modem
component: Network
    calc: $this
   units: hours
   every: 30s
    warn: $this < 1
   delay: down 10m multiplier 1.5 max 2h
    info: cable modem was recently rebooted, uptime is less than 1 hour
      to: webmaster

# -----------------------------------------------------------------------------
# Link Speed Monitoring
# Adjust thresholds based on your internet plan

template: hitron_coda_link_speed_low
      on: hitron_coda.link_speed
   class: Utilization
    type: Cable Modem
component: Network
    calc: $this
   units: Mbps
   every: 30s
    warn: $this < 500    # Adjust based on your internet plan
    crit: $this < 200    # Adjust based on your internet plan
   delay: down 2m multiplier 1.5 max 30m
    info: cable modem link speed is below expected levels
      to: webmaster

# -----------------------------------------------------------------------------
# Connectivity Monitoring
# Critical: No data received from modem for extended period

 alarm: hitron_coda_modem_unreachable
    on: hitron_coda.downstream_power
   class: Latency  
    type: Cable Modem
component: Network
    calc: $this
   every: 30s
    crit: $this == nan
   delay: down 2m multiplier 1.5 max 10m
    info: cable modem is not responding or unreachable
      to: webmaster

# -----------------------------------------------------------------------------
# Channel Count Monitoring
# Your modem normally has 31 downstream + 5 upstream QAM channels

 alarm: hitron_coda_downstream_channels_reduced
    on: hitron_coda.downstream_power
   class: Workload
    type: Cable Modem
component: Network
    calc: $this
   every: 60s
    warn: netdata.statsd_metrics.count < 25  # Less than 25 of 31 channels
    crit: netdata.statsd_metrics.count < 15  # Less than 15 of 31 channels
   delay: down 5m multiplier 1.5 max 1h
    info: fewer downstream channels active than expected
      to: webmaster

 alarm: hitron_coda_upstream_channels_reduced
    on: hitron_coda.upstream_power
   class: Workload
    type: Cable Modem
component: Network
    calc: $this
   every: 60s
    warn: netdata.statsd_metrics.count < 4   # Less than 4 of 5 channels
    crit: netdata.statsd_metrics.count < 2   # Less than 2 of 5 channels
   delay: down 5m multiplier 1.5 max 1h
    info: fewer upstream channels active than expected
      to: webmaster

# -----------------------------------------------------------------------------
# OFDM Channel Monitoring
# Alert if OFDM channels become unavailable

 alarm: hitron_coda_ofdm_downstream_offline
    on: hitron_coda.ofdm_downstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: $this
   every: 60s
    crit: $this == nan
   delay: down 5m multiplier 1.5 max 1h
    info: OFDM downstream channels are offline, high-speed connectivity may be affected
      to: webmaster

# -----------------------------------------------------------------------------
# Performance Degradation Composite Alert
# Creates overall performance score based on multiple metrics

 alarm: hitron_coda_performance_degraded
    on: hitron_coda.downstream_power
   class: Latency
    type: Cable Modem
component: Network
    calc: (($hitron_coda.downstream_power.average / 10 > -10 AND $hitron_coda.downstream_power.average / 10 < 10) ? 1 : 0) + (($hitron_coda.downstream_snr.average / 100 > 30) ? 1 : 0) + (($hitron_coda.upstream_power.average / 100 > 35 AND $hitron_coda.upstream_power.average / 100 < 50) ? 1 : 0)
   every: 120s
    warn: $this < 2
    crit: $this < 1
   delay: down 5m multiplier 1.5 max 1h
    info: overall cable modem performance is degraded across multiple metrics
      to: webmaster

 alarm: hitron_coda_high_error_channel
    on: hitron_coda.downstream_corrected
   class: Errors
    type: Cable Modem
component: Network
    calc: $this
   units: errors/s
   every: 60s
    warn: $this > 500
    crit: $this > 2000
   delay: down 3m multiplier 1.5 max 30m
    info: one or more channels showing very high corrected error rates
      to: webmaster
